<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coete - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React y Babel para que funcione en el navegador sin compilar -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Fuentes -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Roboto+Mono:wght@500&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 transition-colors duration-300">
    <div id="root"></div>

    <script type="module">
        // --- 1. IMPORTAR LIBRER√çAS DE FIREBASE (Versi√≥n Web Modular) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- 2. TU CONFIGURACI√ìN DE FIREBASE (YA INSERTADA) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDIfYedJ-S-fvVeRHRq3o-BEv0es_EUH9U",
            authDomain: "coete-system.firebaseapp.com",
            projectId: "coete-system",
            storageBucket: "coete-system.firebasestorage.app",
            messagingSenderId: "139946462232",
            appId: "1:139946462232:web:fcc25397ebaac8c10cc76d"
        };

        // Inicializar la conexi√≥n
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("üî• Dashboard conectado a Firebase");
        } catch (e) {
            console.error("Error conectando Firebase:", e);
        }

        // --- 3. APLICACI√ìN REACT (DASHBOARD) ---
        import React, { useState, useEffect } from "https://esm.sh/react@18";
        import ReactDOM from "https://esm.sh/react-dom@18";

        const Dashboard = () => {
            const [darkMode, setDarkMode] = useState(false);
            const [local, setLocal] = useState('coete1');
            const [data, setData] = useState([]);
            const [stats, setStats] = useState({ ventaSemanal: 0, ticketPromedio: 0, diferenciaCaja: 0 });
            const [stockFaltantes, setStockFaltantes] = useState({});
            const [cuentasStats, setCuentasStats] = useState({ pendiente: 0, pagado: 0 });
            const [mantencionesStats, setMantencionesStats] = useState({ reportados: 0, enProceso: 0 });
            const [eventosStats, setEventosStats] = useState({ confirmados: 0, potencial: 0 });
            const [loading, setLoading] = useState(true);

            // Efecto: Se ejecuta al abrir la p√°gina para traer datos
            useEffect(() => {
                const fetchData = async () => {
                    if (!db) return; // Si no hay base de datos, no hacemos nada

                    try {
                        // Consulta: Trae la colecci√≥n "cierres", ordenada por fecha (m√°s reciente primero), m√°ximo 7
                        const q = query(collection(db, "cierres"), orderBy("fecha", "desc"), limit(7));
                        const querySnapshot = await getDocs(q);

                        const cierres = [];
                        let totalVenta = 0;
                        let totalDiferencia = 0;
                        const quiebresCount = {}; // Para contar frecuencia de quiebres

                        // Procesamos cada cierre que lleg√≥
                        querySnapshot.forEach((doc) => {
                            const d = doc.data();
                            // Filtrar por local (solo si no es 'ambos')
                            if (local !== 'ambos' && d.local !== local) return;
                            cierres.push(d);
                            totalVenta += Number(d.totalVenta) || 0;
                            totalDiferencia += Number(d.diferenciaCaja) || 0;
                            
                            // Contar quiebres de stock
                            if (d.stockFaltante && Array.isArray(d.stockFaltante)) {
                                d.stockFaltante.forEach(item => {
                                    quiebresCount[item] = (quiebresCount[item] || 0) + 1;
                                });
                            }
                        });

                        // Preparamos los datos para el gr√°fico (Invertimos para que sea Cronol√≥gico: Lun -> Dom)
                        const chartData = cierres.reverse().map(c => ({
                            day: c.fechaString ? c.fechaString.split('-')[0] : '?', // Solo el d√≠a (ej: "01")
                            val: Math.round(c.totalVenta / 1000), // Valor en miles para que quepa en la barrita
                            height: Math.min(100, (c.totalVenta / 600000) * 100) + '%' // Altura visual relativa a una meta de 600k
                        }));

                        setData(chartData);
                        setStats({
                            ventaSemanal: totalVenta,
                            // Ticket promedio estimado (asumiendo ticket de $5.000 aprox, o dividiendo por # transacciones si tuvi√©ramos)
                            // Aqu√≠ hacemos un estimado simple dividiendo por una constante para mostrar algo
                            ticketPromedio: cierres.length > 0 ? Math.round(totalVenta / (cierres.length * 40)) : 0,
                            diferenciaCaja: totalDiferencia
                        });
                        setStockFaltantes(quiebresCount);

                        // Fetch Cuentas (filtrar por local)
                        const cuentasSnap = await getDocs(collection(db, "cuentas"));
                        let pendiente = 0, pagado = 0;
                        cuentasSnap.forEach(doc => {
                            const c = doc.data();
                            if (local !== 'ambos' && c.local !== local) return;
                            if (c.estado === 'pendiente') pendiente += Number(c.monto) || 0;
                            else pagado += Number(c.monto) || 0;
                        });
                        setCuentasStats({ pendiente, pagado });

                        // Fetch Mantenciones (filtrar por local)
                        const mantSnap = await getDocs(collection(db, "mantenciones"));
                        let reportados = 0, enProceso = 0;
                        mantSnap.forEach(doc => {
                            const m = doc.data();
                            if (local !== 'ambos' && m.local !== local) return;
                            if (m.estado === 'reportado') reportados++;
                            else if (m.estado === 'en_proceso') enProceso++;
                        });
                        setMantencionesStats({ reportados, enProceso });

                        // Fetch Eventos
                        const eventosSnap = await getDocs(collection(db, "eventos"));
                        let confirmados = 0, potencial = 0;
                        eventosSnap.forEach(doc => {
                            const e = doc.data();
                            if (e.estado === 'confirmado') {
                                confirmados++;
                                potencial += Number(e.total) || 0;
                            }
                        });
                        setEventosStats({ confirmados, potencial });

                        setLoading(false);

                    } catch (e) {
                        console.error("Error trayendo datos:", e);
                        setLoading(false);
                    }
                };
                fetchData();
            }, [local]); // Re-fetch cuando cambia el local

            return React.createElement("div", { className: `max-w-md mx-auto min-h-screen pb-10 transition-colors duration-300 ${darkMode ? 'bg-slate-900 text-slate-100' : 'bg-[#f8fafc] text-slate-800'}` },

                // Header
                React.createElement("header", { className: `px-6 pt-8 pb-6 border-b sticky top-0 z-10 flex justify-between items-start ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}` },
                    React.createElement("div", null,
                        React.createElement("h1", { className: "text-xl font-bold tracking-tight" }, "Panel de Control"),
                        React.createElement("div", { className: "flex gap-2 mt-2" },
                            React.createElement("button", { onClick: () => setLocal('coete1'), className: `px-3 py-1 rounded-full text-xs font-bold transition-all ${local === 'coete1' ? 'bg-[#ff6b00] text-white' : darkMode ? 'bg-slate-800 text-slate-400' : 'bg-slate-100 text-slate-500'}` }, "Coete 1"),
                            React.createElement("button", { onClick: () => setLocal('coete2'), className: `px-3 py-1 rounded-full text-xs font-bold transition-all ${local === 'coete2' ? 'bg-[#ff6b00] text-white' : darkMode ? 'bg-slate-800 text-slate-400' : 'bg-slate-100 text-slate-500'}` }, "Coete 2"),
                            React.createElement("button", { onClick: () => setLocal('ambos'), className: `px-3 py-1 rounded-full text-xs font-bold transition-all ${local === 'ambos' ? 'bg-purple-500 text-white' : darkMode ? 'bg-slate-800 text-slate-400' : 'bg-slate-100 text-slate-500'}` }, "Ambos")
                        )
                    ),
                    React.createElement("button", { onClick: () => setDarkMode(!darkMode), className: "p-2 rounded-full bg-slate-100 dark:bg-slate-800 text-orange-500" }, darkMode ? "‚òÄÔ∏è" : "üåô")
                ),

                // Contenido Principal
                React.createElement("div", { className: "p-6 space-y-6" },

                    // Tarjetas de KPI (Indicadores Clave)
                    React.createElement("div", { className: "grid grid-cols-2 gap-3" },
                        // Venta Total (Ocupa 2 columnas)
                        React.createElement("div", { className: `col-span-2 p-5 rounded-2xl shadow-sm border ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}` },
                            React.createElement("p", { className: "text-sm font-semibold text-slate-500 mb-2" }, "Venta Acumulada (√öltimos 7)"),
                            React.createElement("div", { className: "text-3xl font-bold font-mono tracking-tight" }, loading ? "..." : `$${stats.ventaSemanal.toLocaleString('es-CL')}`)
                        ),
                        // Diferencias de Caja
                        React.createElement("div", { className: `p-4 rounded-2xl shadow-sm border ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}` },
                            React.createElement("p", { className: "text-xs font-semibold text-slate-400 mb-1" }, "Diferencias Caja"),
                            React.createElement("p", { className: `text-xl font-bold font-mono ${stats.diferenciaCaja < 0 ? 'text-red-500' : 'text-green-500'}` }, loading ? "..." : stats.diferenciaCaja.toLocaleString())
                        ),
                        // Ticket Promedio (Estimado)
                        React.createElement("div", { className: `p-4 rounded-2xl shadow-sm border ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}` },
                            React.createElement("p", { className: "text-xs font-semibold text-slate-400 mb-1" }, "Ticket Prom (Est)"),
                            React.createElement("p", { className: "text-xl font-bold font-mono" }, loading ? "..." : `$${stats.ticketPromedio.toLocaleString()}`)
                        )
                    ),

                    // Gr√°fico de Barras
                    React.createElement("div", { className: `p-5 rounded-2xl shadow-sm border ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}` },
                        React.createElement("h3", { className: "font-bold mb-4" }, "Evoluci√≥n de Ventas"),

                        loading ? React.createElement("p", { className: "text-center py-10 text-slate-400" }, "Cargando gr√°fico...") :

                            React.createElement("div", { className: "flex items-end justify-between h-40 gap-2 pt-4 border-b border-slate-100 pb-2" },
                                data.length > 0 ? data.map((d, i) => React.createElement("div", { key: i, className: "flex flex-col items-center gap-2 w-full h-full justify-end" },
                                    // La Barra
                                    React.createElement("div", { className: "w-full max-w-[24px] bg-[#ff6b00] rounded-t-md transition-all duration-1000", style: { height: d.height } }),
                                    // El D√≠a
                                    React.createElement("span", { className: "text-[10px] font-bold text-slate-400" }, d.day)
                                )) : React.createElement("p", { className: "text-xs text-slate-400 w-full text-center" }, "Sin datos a√∫n. ¬°Haz un cierre para ver magia!")
                            )
                    ),

                    // Panel de Quiebres de Stock
                    React.createElement("div", { className: `p-5 rounded-2xl shadow-sm border ${Object.keys(stockFaltantes).length > 0 ? 'border-red-200 bg-red-50' : darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}` },
                        React.createElement("div", { className: "flex items-center justify-between mb-4" },
                            React.createElement("h3", { className: `font-bold ${Object.keys(stockFaltantes).length > 0 ? 'text-red-700' : ''}` }, "üö® Quiebres de Stock"),
                            Object.keys(stockFaltantes).length > 0 && React.createElement("span", { className: "bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full" }, `${Object.keys(stockFaltantes).length} items`)
                        ),

                        loading ? React.createElement("p", { className: "text-center py-6 text-slate-400" }, "Cargando...") :
                            Object.keys(stockFaltantes).length > 0 ? 
                                React.createElement("div", { className: "space-y-2" },
                                    Object.entries(stockFaltantes)
                                        .sort((a, b) => b[1] - a[1]) // Ordenar por frecuencia
                                        .map(([item, count]) => 
                                            React.createElement("div", { key: item, className: `flex items-center justify-between p-3 rounded-xl ${count >= 3 ? 'bg-red-100 border border-red-300' : darkMode ? 'bg-slate-700' : 'bg-white border border-slate-100'}` },
                                                React.createElement("span", { className: `font-medium ${count >= 3 ? 'text-red-700' : ''}` }, item),
                                                React.createElement("div", { className: "flex items-center gap-2" },
                                                    React.createElement("span", { className: `text-xs font-bold px-2 py-1 rounded-full ${count >= 3 ? 'bg-red-500 text-white animate-pulse' : 'bg-slate-200 text-slate-600'}` }, 
                                                        count >= 3 ? `‚ö†Ô∏è ${count} veces` : `${count}x`
                                                    )
                                                )
                                            )
                                        )
                                )
                            : React.createElement("p", { className: "text-center py-6 text-slate-400 text-sm" }, "‚úÖ Sin quiebres reportados")
                    ),

                    // Panel de M√≥dulos R√°pidos
                    React.createElement("div", { className: `p-5 rounded-2xl shadow-sm border ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}` },
                        React.createElement("h3", { className: "font-bold mb-4" }, "‚ö° Acceso R√°pido"),
                        React.createElement("div", { className: "grid grid-cols-2 gap-3" },
                            
                            // Cuentas
                            React.createElement("a", { href: "cuentas.html", className: `p-4 rounded-xl border transition-all hover:scale-105 ${cuentasStats.pendiente > 0 ? 'bg-red-50 border-red-200' : darkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-100'}` },
                                React.createElement("p", { className: "text-2xl mb-1" }, "üí∞"),
                                React.createElement("p", { className: "font-bold text-sm" }, "Cuentas"),
                                cuentasStats.pendiente > 0 && React.createElement("p", { className: "text-xs text-red-500 font-bold" }, `$${(cuentasStats.pendiente/1000).toFixed(0)}k pendiente`)
                            ),
                            
                            // Mantenciones
                            React.createElement("a", { href: "mantenciones.html", className: `p-4 rounded-xl border transition-all hover:scale-105 ${mantencionesStats.reportados > 0 ? 'bg-yellow-50 border-yellow-200' : darkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-100'}` },
                                React.createElement("p", { className: "text-2xl mb-1" }, "üîß"),
                                React.createElement("p", { className: "font-bold text-sm" }, "Mantenciones"),
                                (mantencionesStats.reportados + mantencionesStats.enProceso) > 0 && React.createElement("p", { className: "text-xs text-yellow-600 font-bold" }, `${mantencionesStats.reportados + mantencionesStats.enProceso} pendientes`)
                            ),
                            
                            // Eventos
                            React.createElement("a", { href: "eventos.html", className: `p-4 rounded-xl border transition-all hover:scale-105 ${eventosStats.confirmados > 0 ? 'bg-green-50 border-green-200' : darkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-100'}` },
                                React.createElement("p", { className: "text-2xl mb-1" }, "üéâ"),
                                React.createElement("p", { className: "font-bold text-sm" }, "Eventos"),
                                eventosStats.confirmados > 0 && React.createElement("p", { className: "text-xs text-green-600 font-bold" }, `${eventosStats.confirmados} confirmados`)
                            ),
                            
                            // Cierre
                            React.createElement("a", { href: "cierre.html", className: `p-4 rounded-xl border transition-all hover:scale-105 ${darkMode ? 'bg-slate-700 border-slate-600' : 'bg-orange-50 border-orange-100'}` },
                                React.createElement("p", { className: "text-2xl mb-1" }, "üìù"),
                                React.createElement("p", { className: "font-bold text-sm text-[#ff6b00]" }, "Nuevo Cierre")
                            )
                        )
                    )
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(Dashboard));
    </script>
</body>

</html>